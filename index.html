<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestión de Artículos - Multi Local</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Phosphor Icons - múltiples CDNs para mayor compatibilidad -->
<script src="https://unpkg.com/@phosphor-icons/web@2.0.3/dist/icons.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.0.3/dist/icons.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/regular/style.css">
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- PANTALLA DE AUTENTICACION -->
<div id="authScreen" class="auth-screen">
  <div class="auth-container">
    <div class="auth-header">
      <h1><i class="ph ph-package"></i> Gestión de Productos</h1>
      <p>Accede a tu inventario personal</p>
    </div>

    <div class="auth-tabs">
      <button id="loginTab" class="auth-tab active" onclick="showLogin()">Iniciar Sesión</button>
      <button id="registerTab" class="auth-tab" onclick="showRegister()">Registrarse</button>
    </div>

    <div id="authMessage" class="auth-message" style="display: none;"></div>

    <!-- FORMULARIO LOGIN -->
    <form id="loginForm" class="auth-form active">
      <div class="form-group">
        <label for="loginEmail">
          <i class="ph ph-envelope"></i>
          Email
        </label>
        <input type="email" id="loginEmail" placeholder="tu@email.com" required>
      </div>

      <div class="form-group">
        <label for="loginPassword">
          <i class="ph ph-lock"></i>
          Contraseña
        </label>
        <input type="password" id="loginPassword" placeholder="Tu contraseña" required>
      </div>

      <button type="submit" id="loginBtn" class="auth-btn">
        <span class="btn-text">Iniciar Sesión</span>
        <div class="btn-loader" style="display: none;">
          <i class="ph ph-circle-notch"></i>
        </div>
      </button>
    </form>

    <!-- FORMULARIO REGISTRO -->
    <form id="registerForm" class="auth-form">
      <div class="form-group">
        <label for="registerName">
          <i class="ph ph-user"></i>
          Nombre completo
        </label>
        <input type="text" id="registerName" placeholder="Tu nombre completo" required>
      </div>

      <div class="form-group">
        <label for="registerEmail">
          <i class="ph ph-envelope"></i>
          Email
        </label>
        <input type="email" id="registerEmail" placeholder="tu@email.com" required>
      </div>

      <div class="form-group">
        <label for="registerEmpresa">
          <i class="ph ph-buildings"></i>
          Empresa
        </label>
        <input type="text" id="registerEmpresa" placeholder="Nombre de tu empresa" required>
      </div>

      <div class="form-group">
        <label for="registerTelefono">
          <i class="ph ph-phone"></i>
          Teléfono
        </label>
        <input type="tel" id="registerTelefono" placeholder="Tu número de teléfono" required>
      </div>

      <div class="form-group">
        <label for="registerPassword">
          <i class="ph ph-lock"></i>
          Contraseña
        </label>
        <input type="password" id="registerPassword" placeholder="Mínimo 6 caracteres" required>
      </div>

      <button type="submit" id="registerBtn" class="auth-btn">
        <span class="btn-text">Solicitar Acceso</span>
        <div class="btn-loader" style="display: none;">
          <i class="ph ph-circle-notch"></i>
        </div>
      </button>
    </form>
  </div>
</div>

<!-- APP PRINCIPAL -->
<div id="mainApp" style="display: none;">

<!-- MENU HAMBURGUESA -->
<div class="hamburger-menu-left" onclick="abrirConfiguracion()">
  <div class="line"></div>
  <div class="line"></div>
  <div class="line"></div>
</div>

<h1><i class="ph ph-package"></i> Mis Productos <span id="userInfo"></span></h1>

<div class="product-form-container">
  <div class="form-header-pro" onclick="toggleFormularioProducto()">
    <div class="header-icon">
      <i class="ph ph-x" id="formulario-toggle-icon"></i>
    </div>
    <div class="header-text">
      <h2>Agregar Nuevo Producto</h2>
      <p>Completa la información del producto para agregarlo al inventario</p>
    </div>
  </div>
  
  <div class="form-content" id="form-content-collapsible">
    <div class="form-section">
      <div class="section-title">
        <i class="ph ph-info"></i>
        <span>Información Básica</span>
      </div>
      
      <div class="form-row">
        <div class="input-group-pro">
          <label for="nombre">
            <i class="ph ph-tag"></i>
            Nombre del Producto
            <span class="required">*</span>
          </label>
          <input type="text" id="nombre" placeholder="Ej: Laptop HP Pavilion" class="form-input">
          <div class="input-underline"></div>
        </div>
        
        <div class="input-group-pro">
          <label for="codigo">
            <i class="ph ph-barcode"></i>
            Código/SKU
            <span class="required">*</span>
          </label>
          <input type="text" id="codigo" placeholder="Ej: HP-PAV-001" class="form-input">
          <div class="input-underline"></div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="input-group-pro">
          <label for="marca">
            <i class="ph ph-stamp"></i>
            Marca
            <span class="required">*</span>
          </label>
          <input type="text" id="marca" placeholder="Ej: HP, Samsung, Sony..." class="form-input">
          <div class="input-underline"></div>
        </div>
        
        <div class="input-group-pro">
          <label for="cantidad">
            <i class="ph ph-package"></i>
            Stock Inicial
          </label>
          <input type="number" id="cantidad" placeholder="0" min="0" class="form-input">
          <div class="input-underline"></div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="section-title">
        <i class="ph ph-folders"></i>
        <span>Categorización</span>
      </div>

      <div class="form-row">
        <div class="input-group-pro full-width">
          <label for="grupo">
            <i class="ph ph-folder"></i>
            Grupo/Categoría
          </label>
          <div class="select-wrapper">
            <select id="grupo" class="form-select">
              <option value="">Seleccionar grupo...</option>
            </select>
            <i class="ph ph-caret-down select-arrow"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">
        <i class="ph ph-currency-dollar"></i>
        <span>Precios</span>
      </div>

      <div class="form-row">
        <div class="input-group-pro">
          <label for="precioMayorista">
            <i class="ph ph-currency-dollar"></i>
            Precio Mayorista
            <span class="required">*</span>
          </label>
          <input type="number" id="precioMayorista" placeholder="0.00" step="0.01" min="0" class="form-input">
          <div class="input-underline"></div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="section-title">
        <i class="ph ph-image"></i>
        <span>Imagen del Producto</span>
      </div>
      
      <div class="form-row">
        <div class="image-upload-container">
          <div class="upload-area" onclick="document.getElementById('foto').click()">
            <input type="file" id="foto" accept="image/*" style="display: none;">
            <div class="upload-icon">
              <i class="ph ph-cloud-arrow-up"></i>
            </div>
            <div class="upload-text">
              <span class="upload-title">Agregar Imagen</span>
              <span class="upload-subtitle">Haz clic o arrastra una imagen aquí</span>
            </div>
          </div>
          <div class="file-info">
            <span class="file-input-text">Sin imagen seleccionada</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="form-actions-pro" id="form-actions-collapsible">
    <button type="button" class="btn-cancel" onclick="limpiarFormulario()">
      <i class="ph ph-x"></i>
      Cancelar
    </button>
    <button type="button" onclick="agregar()" class="btn-add-pro">
      <i class="ph ph-plus"></i>
      <span>Agregar Producto</span>
      <div class="btn-loader" style="display: none;">
        <i class="ph ph-circle-notch"></i>
      </div>
    </button>
  </div>
</div>

<!-- Buscador fijo ahora en la parte superior -->
<div class="search-input-container">
  <div class="fixed-filter-buttons">
    <button class="fixed-filter-icon" onclick="abrirFiltroGrupos()" title="Filtrar por grupos">
      <i class="ph ph-folder"></i>
    </button>
    
    <button class="fixed-filter-icon" onclick="abrirFiltroVisibilidad()" title="Filtrar por visibilidad">
      <i class="ph ph-eye"></i>
    </button>
    
    <button class="fixed-filter-icon" onclick="abrirFiltroStock()" title="Filtrar por stock">
      <i class="ph ph-package"></i>
    </button>
  </div>
  
  <input type="text" id="buscador" placeholder="Buscar por nombre, marca o código..." oninput="filtrar()">
  <i class="ph ph-magnifying-glass search-icon"></i>
</div>

<!-- Dropdowns de filtro movidos fuera de la sección -->
<div id="filtroGrupos" class="filter-dropdown" style="display:none;">
  <div class="dropdown-header">
    <h4><i class="ph ph-folder"></i> Filtrar por Grupo</h4>
  </div>
  <select id="filtroGrupo" onchange="filtrarPorGrupo()">
    <option value="">Todos los grupos</option>
  </select>
</div>

<div id="filtroVisibilidad" class="filter-dropdown" style="display:none;">
  <div class="dropdown-header">
    <h4><i class="ph ph-eye"></i> Filtrar por Visibilidad</h4>
  </div>
  <div class="visibility-options">
    <label class="radio-option">
      <input type="radio" name="filtroVis" value="todos" checked onchange="filtrarPorVisibilidad()">
      <span>Todos los artículos</span>
    </label>
    <label class="radio-option">
      <input type="radio" name="filtroVis" value="visibles" onchange="filtrarPorVisibilidad()">
      <span>Solo visibles</span>
    </label>
    <label class="radio-option">
      <input type="radio" name="filtroVis" value="ocultos" onchange="filtrarPorVisibilidad()">
      <span>Solo ocultos</span>
    </label>
  </div>
</div>

<div id="filtroStock" class="filter-dropdown" style="display:none;">
  <div class="dropdown-header">
    <h4><i class="ph ph-package"></i> Filtrar por Stock</h4>
  </div>
  <div class="stock-options">
    <label class="radio-option">
      <input type="radio" name="filtroStock" value="todos" checked onchange="filtrarPorStock()">
      <span>Todos los niveles</span>
    </label>
    <label class="radio-option">
      <input type="radio" name="filtroStock" value="bajo" onchange="filtrarPorStock()">
      <span>Stock bajo</span>
    </label>
    <label class="radio-option">
      <input type="radio" name="filtroStock" value="sin" onchange="filtrarPorStock()">
      <span>Sin stock</span>
    </label>
  </div>
</div>

<div class="lista-header">
  <h2>Lista de artículos</h2>
  <button class="edit-mode-btn" onclick="toggleEditMode()">
    <i class="ph ph-pencil-simple"></i>
  </button>
</div>
<div id="listaArticulos"></div>

<hr class="separator">
<div style="display: flex; align-items: center; gap: 10px;">
  <button onclick="descargarExcel()"><i class="ph ph-file-xls"></i> Descargar Excel de productos marcados para pedir</button>
  <button onclick="resetearTodosLosMarcados()" title="Resetear todos los productos marcados para pedir" style="background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px;">
    <i class="ph ph-arrow-clockwise" style="font-size: 18px;"></i>
  </button>
</div>

<!-- MODAL EDITAR -->
<div id="modalEditar" class="modal">
  <div class="modal-content">
    <h3>Editar Producto</h3>
    <img id="editFoto" src="">
    <input type="text" id="editNombre" placeholder="Nombre">
    <input type="text" id="editMarca" placeholder="Marca">
    <input type="text" id="editCodigo" placeholder="Código">
    <input type="number" id="editCantidad" placeholder="Cantidad en stock" min="0">
    <select id="editGrupo">
      <option value="">Seleccionar grupo</option>
    </select>
    <div class="edit-precios">
      <label>Precio Mayorista:</label>
      <input type="number" id="editPrecioMayorista" placeholder="Precio Mayorista" step="0.01" min="0">
    </div>
    <input type="file" id="editArchivo" accept="image/*">
    <div style="text-align:right;">
      <button onclick="guardarEdicion()">Guardar</button>
      <button onclick="cerrarModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL ELIMINAR -->
<div id="modalEliminar" class="modal">
  <div class="modal-content">
    <h3>¿Estás seguro que quieres eliminar este producto?</h3>
    <div style="text-align:right;">
      <button onclick="confirmarEliminar()">Sí</button>
      <button onclick="cancelarEliminar()">No</button>
    </div>
  </div>
</div>

<!-- SIDEBAR CONFIGURACION -->
<div id="sidebarConfiguracion" class="sidebar">
  <div class="sidebar-content">
    <div class="sidebar-header">
      <h3><i class="ph ph-gear-six"></i> Configuración</h3>
    </div>
    
    <div class="config-section">
      <div class="section-header" onclick="toggleSection('configuracionCarga')">
        <h4><i class="ph ph-toggle-left"></i> Configuración de Carga</h4>
        <span class="toggle-arrow" id="arrow-configuracionCarga"><i class="ph ph-caret-down"></i></span>
      </div>
      <div id="configuracionCarga" class="section-content">
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" id="habilitarNombre" checked>
            <span>Nombre del Producto</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="habilitarCodigo" checked>
            <span>Código/SKU</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="habilitarMarca" checked>
            <span>Marca</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="habilitarCantidad" checked>
            <span>Stock Inicial</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="habilitarGrupo" checked>
            <span>Grupo/Categoría</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="habilitarFoto" checked>
            <span>Imagen del Producto</span>
          </label>
        </div>
        
        <div class="stock-config">
          <label>Stock Mínimo para PDF:</label>
          <div class="input-group">
            <input type="number" id="cantidadMinima" value="5" min="0" max="100">
          </div>
        </div>
        
        <button onclick="aplicarConfiguracionCarga()" class="btn-primary">Aplicar Cambios</button>
      </div>
    </div>



    <div class="config-section">
      <div class="section-header" onclick="toggleSection('gestionGrupos')">
        <h4><i class="ph ph-folder"></i> Gestión de Grupos</h4>
        <span class="toggle-arrow" id="arrow-gestionGrupos"><i class="ph ph-caret-down"></i></span>
      </div>
      <div id="gestionGrupos" class="section-content">
        <div class="input-group">
          <input type="text" id="nuevoGrupo" placeholder="Nombre del nuevo grupo">
          <button onclick="agregarGrupo()" class="btn-primary">Agregar</button>
        </div>
        <div id="listaGrupos" class="grupos-list"></div>
      </div>
    </div>

    <div class="config-section">
      <div class="section-header" onclick="toggleSection('descuentosPorMarca')">
        <h4><i class="ph ph-percent"></i> Descuentos por Marca</h4>
        <span class="toggle-arrow" id="arrow-descuentosPorMarca"><i class="ph ph-caret-down"></i></span>
      </div>
      <div id="descuentosPorMarca" class="section-content">
        <div class="descuento-config">
          <label for="marcaDescuento">Seleccionar Marca:</label>
          <select id="marcaDescuento" class="form-select">
            <option value="">Seleccionar marca...</option>
          </select>
        </div>

        <div class="descuento-input">
          <label for="porcentajeDescuento">Porcentaje de Descuento:</label>
          <div class="input-group">
            <input type="number" id="porcentajeDescuento" placeholder="0" min="0" max="100" step="1">
            <span class="input-suffix">%</span>
          </div>
        </div>

        <div class="descuento-actions">
          <button onclick="aplicarDescuentoPorMarca()" class="btn-primary">
            <i class="ph ph-check"></i> Aplicar Descuento
          </button>
          <button onclick="eliminarDescuentoPorMarca()" class="btn-secondary">
            <i class="ph ph-x"></i> Quitar Descuento
          </button>
        </div>

        <div id="listaDescuentosActivos" class="descuentos-activos">
          <h5>Descuentos Activos:</h5>
          <div id="descuentosActivosList"></div>
        </div>
      </div>
    </div>
    
    <!-- Panel de Administración (solo visible para admin) -->
    <div class="config-section" id="panelAdminSection" style="display: none;">
      <div class="section-header" onclick="toggleSection('panelAdmin')">
        <h4><i class="ph ph-crown"></i> Panel de Administración</h4>
        <span class="toggle-arrow" id="arrow-panelAdmin"><i class="ph ph-caret-down"></i></span>
      </div>
      <div id="panelAdmin" class="section-content">

        <!-- Solicitudes Pendientes -->
        <div class="admin-subsection">
          <div class="subsection-header">
            <h5><i class="ph ph-clock"></i> Solicitudes Pendientes</h5>
            <span class="badge-count" id="badgePendientes">0</span>
          </div>
          <div id="listaSolicitudesPendientes" class="solicitudes-list"></div>
        </div>

        <!-- Usuarios Autorizados -->
        <div class="admin-subsection">
          <div class="subsection-header">
            <h5><i class="ph ph-check-circle"></i> Mayoristas Autorizados</h5>
            <span class="badge-count" id="badgeAutorizados">0</span>
          </div>
          <div id="listaUsuariosAutorizados" class="usuarios-list"></div>
        </div>

        <!-- Gestión de Precios -->
        <div class="admin-subsection">
          <div class="subsection-header">
            <h5><i class="ph ph-currency-dollar"></i> Gestión de Precios</h5>
          </div>
          <div class="precio-config">
            <label for="clienteSeleccionado">Cliente:</label>
            <select id="clienteSeleccionado" onchange="cargarPreciosCliente()">
              <option value="">Seleccionar cliente...</option>
            </select>
          </div>
          <div id="preciosClientePanel" class="precios-panel"></div>
        </div>

      </div>
    </div>

    <!-- Espacio para futuras funciones -->
    <div class="config-section">
      <div class="section-header" onclick="toggleSection('proximamente')">
        <h4><i class="ph ph-wrench"></i> Próximamente</h4>
        <span class="toggle-arrow" id="arrow-proximamente"><i class="ph ph-caret-down"></i></span>
      </div>
      <div id="proximamente" class="section-content">
        <div class="features-compact">
          <span><i class="ph ph-download"></i> Backup</span>
          <span><i class="ph ph-arrows-in-line-horizontal"></i> Importar/Exportar</span>
          <span><i class="ph ph-chart-line"></i> Estadísticas</span>
          <span><i class="ph ph-bell"></i> Alertas</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- OVERLAY -->
<div id="overlay" class="overlay" onclick="cerrarConfiguracion()"></div>


</div> <!-- Cierre de mainApp -->

<!-- MODAL EXCEL INFO -->
<div id="modalExcelInfo" class="modal">
  <div class="modal-content">
    <h3><i class="ph ph-file-xls"></i> Información para Excel</h3>
    <input type="text" id="nombreEmpresa" placeholder="Nombre de la empresa">
    <input type="text" id="nombreUsuario" placeholder="Tu nombre completo">
    <div style="text-align:right; margin-top:15px;">
      <button onclick="generarExcel()">Generar Excel</button>
      <button onclick="cancelarExcel()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRMACION RESET -->
<div id="modalConfirmReset" class="modal-custom" style="display: none;">
  <div class="modal-content-custom">
    <div class="modal-header-custom">
      <i class="ph ph-warning-circle" style="color: #e74c3c; font-size: 20px;"></i>
      <h3 style="margin: 0; color: #2c3e50;">Confirmar Acción</h3>
    </div>
    <div class="modal-body-custom">
      <p id="textoConfirmacion">¿Estás seguro de que quieres desmarcar todos los productos marcados para pedir?</p>
    </div>
    <div class="modal-footer-custom">
      <button onclick="cancelarReset()" class="btn-cancel-custom">Cancelar</button>
      <button onclick="confirmarReset()" class="btn-confirm-custom">Sí, desmarcar</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script src="auth.js"></script>
<script src="database.js"></script>
<script src="script.js"></script>

<!-- Script para inicializar iconos -->
<script>
// Asegurar que los iconos Phosphor se carguen correctamente
document.addEventListener('DOMContentLoaded', function() {
  // Intentar inicializar Phosphor Icons
  if (typeof window.phosphor !== 'undefined') {
    window.phosphor.fill();
  }

  // Fallback: Si los iconos no cargan, usar Unicode
  setTimeout(() => {
    const icons = document.querySelectorAll('i[class*="ph-"]');
    icons.forEach(icon => {
      if (icon.innerHTML === '' || window.getComputedStyle(icon).fontSize === '16px') {
        // El icono no se cargó, usar fallback Unicode
        const className = icon.className;
        if (className.includes('ph-package')) icon.innerHTML = '📦';
        else if (className.includes('ph-envelope')) icon.innerHTML = '✉️';
        else if (className.includes('ph-lock')) icon.innerHTML = '🔒';
        else if (className.includes('ph-user')) icon.innerHTML = '👤';
        else if (className.includes('ph-buildings')) icon.innerHTML = '🏢';
        else if (className.includes('ph-phone')) icon.innerHTML = '📞';
        else if (className.includes('ph-storefront')) icon.innerHTML = '🏪';
        else if (className.includes('ph-sign-out')) icon.innerHTML = '🚪';
        else if (className.includes('ph-magnifying-glass')) icon.innerHTML = '🔍';
        else if (className.includes('ph-shopping-cart')) icon.innerHTML = '🛒';
        else if (className.includes('ph-file-text')) icon.innerHTML = '📄';
        else if (className.includes('ph-clock')) icon.innerHTML = '🕐';
        else if (className.includes('ph-crown')) icon.innerHTML = '👑';
        else if (className.includes('ph-check-circle')) icon.innerHTML = '✅';
        else if (className.includes('ph-currency-dollar')) icon.innerHTML = '💰';
        else if (className.includes('ph-caret-down')) icon.innerHTML = '▼';
        else if (className.includes('ph-caret-up')) icon.innerHTML = '▲';
        else if (className.includes('ph-image')) icon.innerHTML = '🖼️';
        else icon.innerHTML = '•'; // fallback genérico
      }
    });
  }, 1000);
});
</script>
</body>
</html>


